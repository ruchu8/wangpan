<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试添加文件功能</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>测试添加文件功能</h1>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5>添加文件到文件夹</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="folderIndex" class="form-label">文件夹索引</label>
                    <input type="number" class="form-control" id="folderIndex" value="0" min="0">
                </div>
                <div class="mb-3">
                    <label for="fileName" class="form-label">文件名称</label>
                    <input type="text" class="form-control" id="fileName" placeholder="输入文件名">
                </div>
                <div class="mb-3">
                    <label for="fileUrl" class="form-label">文件URL</label>
                    <input type="text" class="form-control" id="fileUrl" placeholder="输入文件URL">
                </div>
                <div class="mb-3">
                    <label for="authToken" class="form-label">认证令牌</label>
                    <input type="text" class="form-control" id="authToken" placeholder="输入管理员令牌">
                </div>
                <button id="addFileBtn" class="btn btn-primary">添加文件</button>
                <div id="result" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('addFileBtn').addEventListener('click', async function() {
            const button = this;
            const resultDiv = document.getElementById('result');
            const folderIndex = document.getElementById('folderIndex').value;
            const fileName = document.getElementById('fileName').value;
            const fileUrl = document.getElementById('fileUrl').value;
            const authToken = document.getElementById('authToken').value;
            
            // 验证输入
            if (!fileName || !fileUrl || !authToken) {
                resultDiv.innerHTML = '<div class="alert alert-warning">请填写所有字段</div>';
                return;
            }
            
            // 禁用按钮并显示加载状态
            button.disabled = true;
            button.textContent = '添加中...';
            resultDiv.innerHTML = '<div class="alert alert-info">正在添加文件...</div>';
            
            try {
                // 获取现有文件列表
                const response = await fetch('/api/files', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`获取文件列表失败: ${response.status}`);
                }
                
                const files = await response.json();
                
                if (folderIndex < 0 || folderIndex >= files.length || files[folderIndex].type !== 'folder') {
                    throw new Error('无效的文件夹索引');
                }
                
                // 添加时间戳到文件名
                const now = new Date();
                const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
                const fileNameWithTimestamp = `${fileName}_${timestamp}`;
                
                // 添加文件到文件夹
                const newFile = {
                    name: fileNameWithTimestamp,
                    type: 'file',
                    url: fileUrl
                };
                
                files[folderIndex].children.push(newFile);
                
                // 更新文件夹
                const updateResponse = await fetch('/api/files', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        index: parseInt(folderIndex),
                        file: files[folderIndex]
                    })
                });
                
                if (updateResponse.ok) {
                    resultDiv.innerHTML = '<div class="alert alert-success">文件添加成功!</div>';
                } else {
                    const errorData = await updateResponse.json();
                    throw new Error(errorData.error || '添加文件失败');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">错误: ${error.message}</div>`;
            } finally {
                // 恢复按钮状态
                button.disabled = false;
                button.textContent = '添加文件';
            }
        });
    </script>
</body>
</html>