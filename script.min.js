let files=[],comments=[],expandedFolderIndex=-1,currentPage=1,totalPages=1,totalComments=0,filteredFiles=[],fileListElement=null,noFilesElement=null,commentsListElement=null;async function fetchFiles(){try{const e=await fetch("/api/files");if(e.ok){const t=await e.json();files=t,filteredFiles=[...files]}else e.status,useDefaultFiles();renderFileList()}catch(e){useDefaultFiles(),renderFileList()}}function useDefaultFiles(){files=[{name:"BOSS计时器下载专区-",type:"folder",url:"#",note:"BOSS计时器下载专区【部分杀毒会报毒介意的勿下载】",children:[{name:"晚上我打大大撒打算.txt",type:"file",url:"https://www.baidu.com"},{name:"文件2.jpg",type:"file",url:"https://www.qq.com"},{name:"文件3.pdf",type:"file",url:"#"}],expanded:!1},{name:"辅助类相关工具下载（易语言编写部分杀毒会报毒）",type:"folder",url:"#",note:"部分杀毒会误报毒。介意勿下载",children:[{name:"文件4.doc",type:"file",url:"#"},{name:"文件5.png",type:"file",url:"#"}],expanded:!1},{name:"石墓祖玛阁不迷路补丁(带房间补丁版)",type:"folder",url:"#",note:"祖玛阁石墓阵带房间编号带每个房间GPS导航",children:[{name:"文件6.mp3",type:"file",url:"#"},{name:"文件7.zip",type:"file",url:"#"}],expanded:!1},{name:"怪物以及BOSS射线提示补丁",type:"folder",url:"#",note:"【怪物专区】",children:[{name:"文件8.txt",type:"file",url:"#"},{name:"文件9.jpg",type:"file",url:"#"}],expanded:!1},{name:"蓝盾、小火墙、小冰咆哮 等技能类 补丁-",type:"folder",url:"#",note:"【技能补丁专区】",children:[{name:"文件10.doc",type:"file",url:"#"},{name:"文件11.png",type:"file",url:"#"}],expanded:!1},{name:"大小地板砖贴图",type:"folder",url:"#",note:"【地砖专区】",children:[{name:"文件12.pdf",type:"file",url:"#"},{name:"文件13.zip",type:"file",url:"#"}],expanded:!1}],filteredFiles=[...files]}function cacheDOMElements(){fileListElement||(fileListElement=document.getElementById("fileList")),noFilesElement||(noFilesElement=document.getElementById("noFiles")),commentsListElement||(commentsListElement=document.getElementById("commentsList"))}function renderFileList(){if(cacheDOMElements(),!fileListElement)return;const e=document.createDocumentFragment();function t(e,n,i=!1){const a=document.createElement("li");if(a.className="list-group-item","divider"===e.type)return a.className="list-group-item py-1",a.innerHTML='<div class="divider-line">'+(e.name||"=================")+"</div>",a;const s=document.createElement("a");s.href=e.url||"#",s.className="file-name",s.target="_blank";let r="";if("folder"===e.type)r="bi-folder2-open folder-icon";else{switch(e.name.split(".").pop().toLowerCase()){case"txt":r="bi-file-text";break;case"jpg":case"jpeg":case"png":case"gif":case"bmp":case"svg":r="bi-file-image";break;case"pdf":r="bi-file-pdf";break;case"doc":case"docx":r="bi-file-word";break;case"xls":case"xlsx":r="bi-file-excel";break;case"ppt":case"pptx":r="bi-file-ppt";break;case"zip":case"rar":case"7z":case"tar":case"gz":r="bi-file-zip";break;case"mp3":case"wav":case"ogg":case"flac":r="bi-file-music";break;case"mp4":case"avi":case"mkv":case"mov":case"wmv":r="bi-file-play";break;default:r="bi-file-earmark"}}let l="",o=!1;if("file"===e.type){const t=e.date||e.createdAt;if(t){let e;if(t.includes("T"))e=new Date(t);else if(t.includes(" ")){const[n,i]=t.split(" "),[a,s,r]=n.split("-"),[l,o]=i.split(":");e=new Date(a,s-1,r,l,o)}else e=new Date(t);o=(new Date-e)/36e5<=24}}else e.children&&e.children.length>0&&(o=e.children.some(e=>{const t=e.date||e.createdAt;if(t){let e;if(t.includes("T"))e=new Date(t);else if(t.includes(" ")){const[n,i]=t.split(" "),[a,s,r]=n.split("-"),[l,o]=i.split(":");e=new Date(a,s-1,r,l,o)}else e=new Date(t);return(new Date-e)/36e5<=24}return!1}));if("folder"===e.type){l=`<i class="bi ${r}"></i> ${e._highlightedName||e.name}`}else{const t=e._highlightedName||e.name;let n="img/tu.png",i=e.url;e.url&&e.url.includes("/")&&(i=e.url.split("/").pop()||e.url),i&&i.includes(".jpg?lx=xz")?n="img/jpg.png":i&&i.includes(".gif?lx=xz")?n="img/gif.png":i&&i.includes(".txt?lx=xz")&&(n="img/txt.png"),l=`<img src="${n}" alt="文件图标" style="width: 16px; height: 16px; margin-right: 5px; vertical-align: middle;"> ${t}`}if(e.note&&(l+=` <span class="file-note">${e.note}</span>`),"file"===e.type){let t=e.date||e.createdAt;if(!t){const e=new Date;t=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}l+=` <span class="file-date">${t}</span>`}s.innerHTML=l,o?s.classList.add("new-item"):s.classList.remove("new-item"),"folder"===e.type&&(s.href+="/",s.addEventListener("click",e=>{e.preventDefault(),expandedFolderIndex=expandedFolderIndex===n?-1:n,renderFileList()})),a.appendChild(s);if("folder"===e.type&&(expandedFolderIndex===n||!0===e.expanded)&&e.children){const n=Array.isArray(e.children)?e.children:[];if(n.length>0){const e=document.createElement("ul");e.className="ms-2 mt-1",n.forEach((n,i)=>{const a=t(n,i,!0);e.appendChild(a)}),a.appendChild(e)}}return a}fileListElement.innerHTML="",Array.isArray(filteredFiles)?0===filteredFiles.length?(fileListElement&&fileListElement.classList.add("d-none"),noFilesElement&&noFilesElement.classList.remove("d-none")):(fileListElement&&fileListElement.classList.remove("d-none"),noFilesElement&&noFilesElement.classList.add("d-none"),filteredFiles.forEach((n,i)=>{const a=t(n,i);e.appendChild(a)}),fileListElement.appendChild(e)):(filteredFiles=[],fileListElement&&fileListElement.classList.add("d-none"),noFilesElement&&noFilesElement.classList.remove("d-none"))}function highlightSearchTerm(e,t){if(!t)return e;const n=new RegExp(`(${t})`,"gi");return e.replace(n,'<mark class="search-highlight">$1</mark>')}function searchFiles(){const e=document.getElementById("searchInput").value.toLowerCase().trim();if(""===e)filteredFiles=[...files];else{filteredFiles=[],filteredFiles=function t(n){const i=[];return n.forEach(n=>{if(n.name.toLowerCase().includes(e)){const a={...n,_highlightedName:highlightSearchTerm(n.name,e)};if("folder"===n.type&&n.children&&n.children.length>0){const e=t(n.children);a.children=e,e.length>0&&(a.expanded=!0)}i.push(a)}else if("folder"===n.type&&n.children&&n.children.length>0){const a=t(n.children);if(a.length>0){const t={...n,_highlightedName:highlightSearchTerm(n.name,e),children:a,expanded:!0};i.push(t)}}}),i}(files)}expandedFolderIndex=-1,renderFileList()}async function fetchComments(e=1){try{const t=await fetch(`/api/comments?page=${e}&limit=8`);if(t.ok){const e=await t.json();comments=e.comments,currentPage=e.currentPage,totalPages=e.totalPages,totalComments=e.totalComments,renderComments(),renderCommentsStats(),renderPagination()}else commentsListElement&&(commentsListElement.innerHTML='<p class="text-center py-4 text-muted">暂无留言</p>')}catch(e){commentsListElement&&(commentsListElement.innerHTML='<p class="text-center py-4 text-muted">加载留言失败</p>')}}function renderComments(){if(cacheDOMElements(),!commentsListElement)return;if(commentsListElement.innerHTML="",0===comments.length)return void(commentsListElement.innerHTML='<p class="text-center py-4 text-muted">暂无留言</p>');const e=document.createDocumentFragment();comments.forEach(t=>{const n=document.createElement("div");n.className="bg-white rounded-lg p-4 message-shadow message-hover";const i=new Date(t.date).toLocaleString();let a="访客",s="",r="";if(t.name.includes(":")){const[e,n]=t.name.split(":",2);r=e,s=maskContactInfo(n),a="访客"}let l="",o="";"QQ"===r?o='<i class="fa fa-qq mr-1 text-gray-400" aria-hidden="true"></i>':"微信"===r?o='<i class="fa fa-weixin mr-1 text-gray-400" aria-hidden="true"></i>':"邮箱"===r&&(o='<i class="fa fa-envelope mr-1 text-gray-400" aria-hidden="true"></i>'),l+=`\n            <div class="comment-item-header">\n                <div class="comment-item-user">\n                    <div class="comment-item-avatar">\n                        <i class="fa fa-user text-xs" aria-hidden="true"></i>\n                    </div>\n                    <div>\n                        <div class="comment-item-name">${a}</div>\n                        <div class="comment-item-contact">\n                            ${o}\n                            ${s||"访客"}\n                        </div>\n                    </div>\n                </div>\n                <div class="comment-item-date">\n                    <i class="fa fa-clock-o mr-1" aria-hidden="true"></i>\n                    ${i}\n                </div>\n            </div>\n        `;let c="";if(c=t.approved?t.content:"此留言不公开，管理员回复后才能公开留言",l+=`\n            <div class="comment-item-content">\n                <p class="text-gray-700 text-sm leading-tight">\n                    ${c}\n                </p>\n            </div>\n        `,t.reply){let e="";if(t.reply_date){e=new Date(t.reply_date).toLocaleString()}l+=`\n                <div class="comment-item-reply">\n                    <div class="comment-item-reply-header">\n                        <div class="comment-item-reply-title">\n                            <i class="fa fa-shield mr-1" aria-hidden="true"></i>\n                            管理员回复\n                        </div>\n                        <div class="comment-item-reply-time">\n                            ${e}\n                        </div>\n                    </div>\n                    <div class="comment-item-reply-content">\n                        <p class="text-gray-700 text-sm leading-tight">\n                            ${t.reply}\n                        </p>\n                    </div>\n                </div>\n            `}t.approved||(n.classList.add("border","border-amber-100"),l=`\n                <div class="comment-item-header">\n                    <div class="comment-item-user">\n                        <div class="comment-item-avatar">\n                            <i class="fa fa-user text-xs" aria-hidden="true"></i>\n                        </div>\n                        <div>\n                            <div class="comment-item-name">${a}</div>\n                            <div class="comment-item-contact">\n                                ${o}\n                                ${s||"访客"}\n                            </div>\n                        </div>\n                    </div>\n                    <div class="flex items-center">\n                        <span class="comment-item-pending-tag">\n                            待回复\n                        </span>\n                        <div class="comment-item-date">\n                            <i class="fa fa-clock-o mr-1" aria-hidden="true"></i>\n                            ${i}\n                        </div>\n                    </div>\n                </div>\n                <div class="comment-item-content">\n                    <p class="text-gray-700 text-sm leading-tight">\n                        ${c}\n                    </p>\n                </div>\n            `),n.innerHTML=l,e.appendChild(n)}),commentsListElement.appendChild(e)}function renderCommentsStats(){const e=document.getElementById("totalCommentsCount"),t=document.getElementById("repliedCommentsCount"),n=document.getElementById("pendingCommentsCount");if(!e)return;e.textContent=totalComments;let i=0,a=0;comments.forEach(e=>{e.reply&&""!==e.reply.trim()?i++:a++}),t&&(t.textContent=i),n&&(n.textContent=a)}function renderPagination(){const e=document.getElementById("pagination");if(!e)return;if(totalPages<=1)return void(e.innerHTML="");let t,n,i="";i+=currentPage>1?`\n            <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50" data-page="${currentPage-1}">\n                <i class="fa fa-chevron-left text-xs" aria-hidden="true"></i>\n            </a>\n        `:'\n            <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500" disabled>\n                <i class="fa fa-chevron-left text-xs" aria-hidden="true"></i>\n            </a>\n        ',totalPages<=5?(t=1,n=totalPages):currentPage<=3?(t=1,n=5):currentPage+2>=totalPages?(t=totalPages-4,n=totalPages):(t=currentPage-2,n=currentPage+2),t>1&&(i+='\n            <a href="#" class="relative inline-flex items-center px-3 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50" data-page="1">1</a>\n        ',t>2&&(i+='\n                <span class="relative inline-flex items-center px-3 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>\n            '));for(let e=t;e<=n;e++)i+=e===currentPage?`\n                <a href="#" class="relative inline-flex items-center px-3 py-2 border border-gray-300 bg-primary text-sm font-medium text-white" data-page="${e}">${e}</a>\n            `:`\n                <a href="#" class="relative inline-flex items-center px-3 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50" data-page="${e}">${e}</a>\n            `;n<totalPages&&(n<totalPages-1&&(i+='\n                <span class="relative inline-flex items-center px-3 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>\n            '),i+=`\n            <a href="#" class="relative inline-flex items-center px-3 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50" data-page="${totalPages}">${totalPages}</a>\n        `),i+=currentPage<totalPages?`\n            <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50" data-page="${currentPage+1}">\n                <i class="fa fa-chevron-right text-xs" aria-hidden="true"></i>\n            </a>\n        `:'\n            <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500" disabled>\n                <i class="fa fa-chevron-right text-xs" aria-hidden="true"></i>\n            </a>\n        ',e.innerHTML=i,e.querySelectorAll("a[data-page]").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=parseInt(this.getAttribute("data-page"));t&&t!==currentPage&&!this.hasAttribute("disabled")&&fetchComments(t)})})}function maskContactInfo(e){if(!e)return e;if(e.includes("@")){const[t,n]=e.split("@");if(t.length<=5)return e;return`${`${t.substring(0,4)}**${t.substring(t.length-4)}`}@${n}`}if(e.length<=3)return e;if(5===e.length){return`${e.substring(0,3)}**${e.substring(e.length-3)}`}return`${e.substring(0,3)}**${e.substring(e.length-5)}`}async function getClientIP(){try{try{const e=new AbortController,t=setTimeout(()=>e.abort(),5e3),n=await fetch("https://api.ip.sb/ip",{method:"GET",mode:"cors",signal:e.signal});if(clearTimeout(t),n.ok){const e=await n.text();if(e&&e.trim())return e.trim()}}catch(e){}try{const e=new AbortController,t=setTimeout(()=>e.abort(),5e3),n=await fetch("https://ipapi.co/json/",{method:"GET",mode:"cors",signal:e.signal});if(clearTimeout(t),n.ok){const e=await n.json();if(e&&e.ip)return e.ip}}catch(e){}try{const e=new AbortController,t=setTimeout(()=>e.abort(),5e3),n=await fetch("https://ipinfo.io/json",{method:"GET",mode:"cors",signal:e.signal});if(clearTimeout(t),n.ok){const e=await n.json();if(e&&e.ip)return e.ip}}catch(e){}try{const e=new AbortController,t=setTimeout(()=>e.abort(),3e3),n=await fetch("/api/ip",{method:"GET",signal:e.signal});if(clearTimeout(t),n.ok){const e=await n.json();if(e&&e.ip)return e.ip}}catch(e){}const e=localStorage.getItem("clientIP");return e||"未知"}catch(e){return"未知"}}async function submitComment(e){e.preventDefault();const t=document.getElementById("contactType").value,n=document.getElementById("contactInfo").value,i=document.getElementById("commentContent").value,a=document.getElementById("submitCommentBtn");if(t)if(n&&0!==n.trim().length){if("QQ"===t){if(!/^[1-9][0-9]{4,14}$/.test(n.trim()))return void showCommentStatus("请输入有效的QQ号码（5-15位数字，不能以0开头）","error")}else if("微信"===t){if(!/^[a-zA-Z0-9_-]{6,20}$/.test(n.trim())||/^\d+$/.test(n.trim()))return void showCommentStatus("请输入有效的微信号（6-20位，可包含字母、数字、下划线、减号，不能纯数字）","error")}else if("邮箱"===t){if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n.trim()))return void showCommentStatus("请输入有效的邮箱地址","error")}if(!i||i.trim().length<=3)showCommentStatus("留言内容至少需要3个字","error");else{a&&(a.disabled=!0,a.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>提交中...'),showCommentStatus("正在提交留言...","info");try{const e=getClientIP(),a=`${t}:${n}`,s=await e,r=await fetch("/api/comments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a,content:i,ip:s})});if(r.ok)document.getElementById("commentForm").reset(),showCommentStatus("留言提交成功，等待审核后显示","success"),fetchComments();else{showCommentStatus((await r.json()).error||"提交失败","error")}}catch(e){showCommentStatus("提交失败，请稍后再试","error")}finally{a&&(a.disabled=!1,a.innerHTML='<i class="bi bi-send me-2"></i>提交留言')}}}else showCommentStatus("请输入联系方式","error");else showCommentStatus("请选择联系方式类型","error")}function showCommentStatus(e,t){const n=document.getElementById("commentStatus");n&&(n.textContent=e,n.className="comment-status",t&&n.classList.add(t),"info"!==t&&setTimeout(()=>{n.className="comment-status"},5e3))}function setupBackToTop(){const e=document.getElementById("backToTop");e&&(window.addEventListener("scroll",()=>{window.pageYOffset>300?e.classList.remove("d-none"):e.classList.add("d-none")}),e.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})}))}function setupSmoothScroll(){document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.getAttribute("href");if("#"===t)return;const n=document.querySelector(t);n&&window.scrollTo({top:n.offsetTop-80,behavior:"smooth"})})})}function updateContactInfoPlaceholderAndHelp(e){const t=document.getElementById("contactInfo"),n=document.getElementById("contactInfoHelp");if(t&&n)switch(e){case"QQ":t.placeholder="请输入您的QQ号码（5-15位数字）",n.textContent="请输入有效的QQ号码，例如：1234567",n.className="form-text text-muted";break;case"微信":t.placeholder="请输入您的微信号（6-20位字母或数字）",n.textContent="请输入有效的微信号，例如：weixin123",n.className="form-text text-muted";break;case"邮箱":t.placeholder="请输入您的邮箱地址",n.textContent="请输入有效的邮箱地址，例如：example@qq.com",n.className="form-text text-muted";break;default:t.placeholder="请输入您的QQ号/微信号/邮箱地址",n.textContent="",n.className="form-text"}}function validateContactInfo(){const e=document.getElementById("contactType").value,t=document.getElementById("contactInfo").value,n=document.getElementById("contactInfoHelp");if(!e||!t||0===t.trim().length)return;let i=!0,a="";if("QQ"===e)/^[1-9][0-9]{4,14}$/.test(t.trim())||(i=!1,a="QQ号码格式不正确，请输入5-15位数字（不能以0开头）");else if("微信"===e)/^[a-zA-Z0-9_-]{6,20}$/.test(t.trim())&&!/^\d+$/.test(t.trim())||(i=!1,a="微信号格式不正确，请输入6-20位（可包含字母、数字、下划线、减号，不能纯数字）");else if("邮箱"===e){/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.trim())||(i=!1,a="邮箱地址格式不正确，请输入有效的邮箱地址")}n&&(n.textContent=a,n.className=i?a?"form-text text-success":"form-text text-muted":"form-text text-danger")}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("searchInput"),t=document.getElementById("searchBtn");if(e&&t){let n;t.addEventListener("click",searchFiles),e.addEventListener("keyup",function(e){"Enter"===e.key&&searchFiles()}),e.addEventListener("input",function(){clearTimeout(n),n=setTimeout(searchFiles,300)})}setInterval(fetchFiles,3e4)}),document.addEventListener("DOMContentLoaded",function(){cacheDOMElements(),fetchFiles(),fetchComments();const e=document.getElementById("commentForm");e&&e.addEventListener("submit",submitComment),setupBackToTop(),setupSmoothScroll(),setInterval(fetchFiles,3e4);const t=document.getElementById("contactType"),n=document.getElementById("contactInfo"),i=document.getElementById("contactInfoHelp");t&&n&&i&&(t.addEventListener("change",function(){updateContactInfoPlaceholderAndHelp(this.value)}),n.addEventListener("input",function(){validateContactInfo()}))}),window.addEventListener("load",function(){});